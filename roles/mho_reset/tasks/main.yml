# Main tasks file for mho_reset
---
- name: Lock database for user admin on {{ ansible_hostname }}
  raw: lock database override
  ignore_errors: yes
  ignore_unreachable: yes
  register: lock_database_result
  vars:
    ansible_user: admin
    ansible_ssh_pass: "{{ lookup('env','MHO_Pass') }}"

- include_tasks: add_user.yml
  vars:
    ansible_user: admin
    ansible_ssh_pass: "{{ lookup('env','MHO_Pass') }}"

- include_tasks: clear_python_env.yml

- name: lock database override for user ansible on {{ ansible_hostname }}
  ignore_errors: yes
  command: clish -c 'lock database override'

- name: Touch (create) file /etc/.asg_auto_confirm on {{ ansible_hostname }}
  file:
    path: /etc/.asg_auto_confirm
    state: touch

- name: delete existing security groups on {{ ansible_hostname }}
  shell: clish -c 'delete maestro security-group id {{ item }} '
  with_sequence: start=1 end=8
 
- name: commit security group changes on {{ ansible_hostname }}
  shell: clish -c 'set maestro security-group apply-new-config' 

- name: pause for reset to begin for 3 minutes
  pause: 
    minutes: 3
    
- name: reset the MHO to FCD on {{ ansible_hostname }}
  shell: clish -c 'set fcd revert Gaia_R80.20SP'  <<< $'Yes'
  register: fcd_revert_result

- name: print the result of fcd revert command
  debug: 
    msg: "{{ fcd_revert_result.stdout_lines }}"

- name: Wait 2 minutes and then from {{ pi_jumphost }} poll every 20 seconds for 10 minutes to check if port 22 on {{ ansible_hostname }} default ip {{ mho_default_ip }} is active and contain "OpenSSH"
  wait_for:
    port: 22
    host: "{{ mho_default_ip }}"
    search_regex: OpenSSH
    timeout: 600
    delay: 120
    sleep: 20
  delegate_to: "{{ pi_jumphost }}"
  vars:
    ansible_user: "{{ lookup('env','PI_USERNAME') }}"
    ansible_ssh_pass: "{{ lookup('env','PI_PASSWORD') }}"
  
